<app-left>
  {{appS.sss('任务变更')}}
  <div class="sider sider-menu">
    <div class="project">
      <nz-select nzSize="large" nzPlaceHolder="请选择项目" [(ngModel)]="project" (ngModelChange)="projectChanges();"
        (nzOpenChange)="piState = !piState">
        <nz-option [nzValue]="item" [nzLabel]="item.name" *ngFor="let item of projectMneu"></nz-option>
      </nz-select>
      <h2 class="text">{{project?.name || '请选择项目'}}</h2>
      <div style="display: flex; flex-direction: column;">
        <i nz-icon nzType="up" nzTheme="outline" [ngClass]="{'active': piState}"></i>
      </div>
    </div>
    <ul>
      <ng-container *ngFor="let item of menu.component; index as i">
        <li class="item" (click)="onMenuOne(item)"
          *ngIf="menu.selectComponent === null || menu.selectComponent === item"
          [ngClass]="{'active': menu.selectComponent === item}">
          {{item}}
          <i nz-icon nzType="up" nzTheme="outline"></i>
        </li>
      </ng-container>
    </ul>
    <ul class="menu-2">
      <li *ngFor="let item of menu.bridge; index as i" [ngClass]="{'active': menu.selectBridge === item.id}"
        (click)="onMenubridge(item.id)">
        <div class="state">
          <div *ngIf="item.cls.e" style="background-color: #d9d9d9"></div>
          <div *ngIf="item.cls.a" style="background-color: #45b787"></div>
          <div *ngIf="item.cls.d" style="background-color: #51c4d3"></div>
          <div *ngIf="item.cls.b" style="background-color: #fcd337"></div>
          <div *ngIf="item.cls.c" style="background-color: #f34718"></div>
        </div>
        {{item.name}}
      </li>
    </ul>
  </div>
  <div class="main">
    <nz-tabset class="task-tabset" (nzSelectChange)="changeTabst($event)">
      <nz-tab nzTitle="基础信息">
        <div class="form-edit">
          <form nz-form [ngClass]="{'form-edit': !appS.edit}" [formGroup]="validateForm" (ngSubmit)="submitForm()">
            <nz-form-item>
              <nz-form-label [nzSm]="3" nzRequired>梁号</nz-form-label>
              <nz-form-control [nzSm]="21" [ngClass]="{'in-error': validateForm.get('name').errors}">
                <input type="text" nz-input placeholder="梁号" formControlName="name">
                <nz-form-explain *ngIf="appS.edit">{{validateForm.get('name').errors | ValidatorError}}
                </nz-form-explain>
              </nz-form-control>
            </nz-form-item>
            <nz-form-item>
              <nz-form-label [nzSm]="3" nzRequired>构建</nz-form-label>
              <nz-form-control [nzSm]="6">
                <div style="display: flex;">
                  <nz-cascader [nzOptions]="componentOptions.menuNames" formControlName="component"
                    (ngModelChange)="componentChange()">
                  </nz-cascader>
                  <button nz-button nzType="primary" nzSearch (click)="onGroup()"
                    type="button" *ngIf="!data?.id" style="z-index: 1">分组</button>
                </div>
                <nz-form-explain *ngIf="validateForm.get('component').dirty && validateForm.get('component').errors">
                  请入选择构建！</nz-form-explain>
              </nz-form-control>

              <nz-form-label [nzSm]="3" nzRequired>设备</nz-form-label>
              <nz-form-control [nzSm]="5">
                <nz-cascader nzMenuClassName="task-cascader" [nzOptions]="jacks" formControlName="device"
                  (ngModelChange)="deviceOnChanges($event)">
                </nz-cascader>
                <nz-form-explain *ngIf="validateForm.get('device').dirty && validateForm.get('device').errors">请入选择设备！
                </nz-form-explain>
              </nz-form-control>
              <!-- <nz-form-label [nzSm]="3" nzRequired>钢绞线</nz-form-label>
              <nz-form-control [nzSm]="4">
                <nz-cascader [nzOptions]="steelStrandOptions" formControlName="steelStrand"
                  (ngModelChange)="steelStrandOnChanges($event)">
                </nz-cascader>
                <nz-form-explain
                  *ngIf="validateForm.get('steelStrand').dirty && validateForm.get('steelStrand').errors">
                  请入选择钢绞线！</nz-form-explain>
              </nz-form-control> -->
            </nz-form-item>

            <div formArrayName="otherInfo" class="other-info">
                <nz-form-item *ngIf="appS.edit" class="divider">
                  <nz-divider style="min-width: auto;" nzText="其他信息" nzOrientation="left"></nz-divider>
                  <button nz-button nzType="primary" nzSearch (click)="otherInfoAdd()" type="button" >添 加</button>
                </nz-form-item>
                <nz-form-item >
                  <ng-container *ngFor="let item of otherInforFormArr.controls; index as i" [formGroupName]="i">
                      <ng-container *ngIf="i === 0">
                        <nz-form-label [nzSm]="3" >浇筑日期</nz-form-label>
                        <nz-form-control [nzSm]="appS.edit ? 21 : 5" [ngClass]="{'in-error': item.get('value').errors}">
                          <nz-date-picker readonly  class="revise-date" nzFormat="yyyy-MM-dd" formControlName="value"></nz-date-picker>
                          <nz-form-explain *ngIf="appS.edit">{{item.get('value').errors | ValidatorError}}</nz-form-explain>
                        </nz-form-control>
                      </ng-container>
                    <div class="other-edit" *ngIf="appS.edit && i > 0">
                      <div style="flex: 1;">
                        <nz-form-control [ngClass]="{'in-error': item.get('key').errors}">
                          <input placeholder="显示名称" nz-input formControlName="key" [nzAutocomplete]="auto" />
                          <nz-autocomplete [nzDataSource]="bridgeOtherKeySelect()" #auto> </nz-autocomplete>
                          <nz-form-explain *ngIf="appS.edit">{{item.get('key').errors | ValidatorError}}</nz-form-explain>
                        </nz-form-control>
                      </div>
                      <div style="flex: 1;">
                          <nz-form-control>
                            <input type="text" nz-input placeholder="实际内容" formControlName="value">
                          </nz-form-control>
                      </div>
                      <div>
                        <button nz-button nzType="default" nzShape="circle" (click)="otherInfoSub(i)"><i nz-icon type="close"></i></button>
                      </div>
                    </div>
                    <ng-container *ngIf="!appS.edit && i > 0">
                      <nz-form-label [nzSm]="3" >{{item.value.key || '显示名称'}}</nz-form-label>
                      <nz-form-control [nzSm]="5">
                        <input type="text" nz-input placeholder="实际内容" formControlName="value">
                      </nz-form-control>
                    </ng-container>
                  </ng-container>
                </nz-form-item>
            </div>

            <nz-form-item *ngIf="data" style="z-index: 2;">
              <nz-form-control>
                <nz-radio-group [nzButtonStyle]="'solid'" [nzDisabled]="edit">
                  <label nz-radio-button [nzValue]="item"
                    *ngFor="let item of holeNames; index as i"
                    (click)="onHoleRadio(item.name)"
                    [ngClass]="{'hole-active': editGroupIndex === i,'hole-base': editGroupIndex===null}"
                    [class]="'hole' + item.cls"
                    >{{item.name}}-{{item.cls}}</label>
                </nz-radio-group>
                <nz-form-explain style="color: #f5222d;"
                  *ngIf="validateForm.get('holeRadio').dirty && validateForm.get('holeRadio').errors">
                  至少需要一组张拉数据！</nz-form-explain>
              </nz-form-control>
            </nz-form-item>
          </form>
          <app-task-data #taskDataDom [jackData]="jackData" [editGroupIndex]="editGroupIndex" ></app-task-data>
          <div class="edit" [ngClass]="{'edit-on': appS.edit}" *ngIf="!appS.edit">
          </div>
        </div>
        <app-record *ngIf="holeData && holeData?.record" [GroupData]="holeData"></app-record>
      </nz-tab>
      <nz-tab nzTitle="设备信息" [nzDisabled]="!jackData">
        <task-jack [data]="jackData" *ngIf="tabsetShow === 1"></task-jack>
      </nz-tab>
      <nz-tab nzTitle="其他">
        其他
      </nz-tab>
    </nz-tabset>

    <div class="operation">
      <div *ngIf="!appS.edit; else elseBlock">
        <button nz-button nzType="primary" nzGhost nzSearch (click)="selectTemplate()" type="button" >选择导出</button>
        <button nz-button nzType="primary" nzGhost nzSearch (click)="derivedExcel()" type="button" >导 出</button>
        <button nz-button nzType="primary" nzSearch (click)="add()" type="button" [disabled]="!project">添 加</button>
        <button nz-button nzType="primary" nzGhost nzSearch (click)="modification()" type="button" *ngIf="data">修 改</button>
        <button nz-button nzType="danger" nzSearch (click)="copy()" type="button" *ngIf="data">复 制</button>
        <button nz-button nzType="primary" nzGhost nzSearch (click)="tension()" type="button" *ngIf="editGroupIndex !== null && (!holeData.record || (holeData?.record && holeData.record.state !== 2 && holeData.record.state !== 3))">张 拉</button>
      </div>
      <ng-template #elseBlock>
        <button nz-button nzType="primary" nzSearch (click)="save()" type="button" *ngIf="appS.edit">保 存</button>
        <button nz-button nzType="danger" nzSearch (click)="saveCancel()" type="button" *ngIf="appS.edit">取 消</button>
      </ng-template>
    </div>
  </div>

</app-left>

<nz-modal nzMaskClosable="false" [nzVisible]="groupIsVisible" nzTitle="手动分组" (nzOnCancel)="groupCancel()"
  (nzOnOk)="groupOk()">
  <app-group #groupDom></app-group>
</nz-modal>

<nz-modal [nzVisible]="tensionDevice.state" nzTitle="设备状态错误！" nzOkText="张拉" nzWidth="80%"
  (nzOnCancel)="cleanTension()"
  (nzOnOk)="tension()">
  <div nz-row nzGutter="25">
    <div nz-col nzSm="24" nzLg="12" class="title" *ngFor="let name of tensionDevice.names; index as i">
      <nz-divider style="min-width: auto;" [nzText]="name + '：设备状态'" nzOrientation="left"></nz-divider>
      <h1>{{name}}·{{PLCS.PD.zA.state}}</h1>
      <h1 *ngIf="tensionDevice[name]"> {{tensionDevice[name]}} </h1>
      <nz-alert nzType="error" *ngFor="let item of PLCS.PD[name].alarm" [nzMessage]="item" nzShowIcon>
      </nz-alert>
    </div>
  </div>
</nz-modal>
